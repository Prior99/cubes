<!DOCTYPE HTML>
<html>
    <head>
        <script type="text/javascript" src="gl-matrix.js"></script>
        <script type="text/javascript" src="graphics.js"></script>
        <script type="text/javascript" src="cube.js"></script>
        <script type="text/javascript" src="game.js"></script>
        <script type="text/javascript" src="shop.js"></script>
        <script type="text/javascript" src="input.js"></script>
        <script type="text/javascript" src="storage.js"></script>
        <script type="text/javascript" src="initgl.js"></script>
        <script type="text/javascript" src="menu.js"></script>
        <script type="text/javascript" src="jquery-2.1.1.min.js"></script>
        <style type="text/css">
            body {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                background: rgb(51, 51, 51);
                overflow: hidden;
            }

            canvas {
                position: absolute;
                left: 0;
                top: 0;
                z-index: 50;
                background: transparent;
            }

            canvas.underlay {
                z-index: 25;
            }

            canvas.overlay {
                z-index: 75;
            }

            div#wrapper {
                position: absolute;
                left: 0;
                top: 0;
                padding-left: 50px;
                z-index: 100;
                overflow: hidden;
                text-align: left;
                background: rgba(0, 0, 0, .3);
                width: 500px;
                height: 100%;
            }

            div.button {
                display: block;
                width: 200px;
                height: 30px;
                color: white;
                margin-top: 10px;
                font-size: 15pt;
                transition: color .2s linear;
            }

            div.button div.description {
                font-size: 12pt;
                padding: 5px;
                width: 0px;
                opacity: 0;
                color: #ccc;
                transition: opacity 0.5s ease-out;
                float: right;
                overflow: hidden;
                height: 0;
                visibility: hidden;
            }

            div.button div.name {
                width: 150px;
                float: left;
                cursor: pointer;
                cursor: hand;
            }

            div.button:hover {
                color: #ffcb2d;
                width: 420px;
            }

            div.button:hover div.description {
                display: block;
                opacity: 1;
                height: auto;
                width: 250px;
                visibility: visible;
            }

        </style>
    </head>
    <body>
        <div id="wrapper">
        </div>
        <canvas width="800" height="600" id="canvas"></canvas>
        <canvas width="800" height="600" id="hud"></canvas>
        <script type="text/javascript">
            var graphics, canvas, cubes, hud;
            canvas = $("#canvas")[0];
            hud = $("#hud")[0];
            cubes = [];

            var cubeTypes = {};
            var cubeTypesLoading = {};

            function getCube(name, callback) {
                if(cubeTypes[name] !== undefined) {
                    cubeTypes[name](callback);
                }
                else {
                    if(cubeTypesLoading[name] !== undefined) {
                        cubeTypesLoading[name].push(callback);
                    }
                    else {
                        cubeTypesLoading[name] = [callback];
                        $.ajax({
                            url : "cubes/" + name,
                            dataType : "text",
                            cache : false,
                            success : function(res) {
                                var c = eval("(" + res + ")");
                                for(cb in cubeTypesLoading[name]) {
                                    c(cubeTypesLoading[name][cb]);
                                }
                                cubeTypesLoading[name] = undefined;
                                cubeTypes[name] = c;
                            }
                        });
                    }
                }
            }

            function resize() {
                graphics.resize(canvas.width = window.innerWidth, canvas.height = window.innerHeight);
                hud.width = window.innerWidth, hud.height = window.innerHeight
            }

            window.addEventListener('resize', function() {
                resize();
            }, false);

            function initGraphics(gl) {
                graphics = new Graphics(canvas.width, canvas.height, cubes, gl, initMenu);
            }

            function initShop() {
                var shop = new Shop(cubes);
                resize();
                graphics.start();
                graphics.setPosition(10, 0, -20);
                shop.start();
            }

            function initMenu() {
                var menu = new Menu(cubes);
                resize();
                graphics.start();
                var animationInterval = setInterval(function() {
                    window.requestAnimationFrame(function() {
                        var remove = [];
                        for(var c in cubes) {
                            var cube = cubes[c];
                            cube.tick();
                            if(cube.distance < 0) remove.push(cube);
                        }
                        for(var c in remove) {
                            cubes.splice(cubes.indexOf(remove[c]), 1);
                        }
                        if(Math.random() < .1) {
                            getCube("fake.js", function(cube) {
                                cube.distance = 16;
                                cube.rotation = Math.PI * 3/4 + Math.random()*Math.PI/2;
                                cube.speed = Math.random()*0.1 + 0.01;
                                cubes.push(cube);
                                if(Math.random() < .1) {
                                    cube.setTexture("energy.png");
                                }
            					graphics.setPosition(8, 0, -5);
                            });
                        }
                    });
                }, 1000/60);
                cubes.push();
                function stopAnimation() {
                    graphics.displayRing();
                    cubes.length = 0;
                    clearInterval(animationInterval);
                }
				menu.addEntry({
					name : "Game",
                    description : "Start a new game with your current selection of cubes.",
					method : function() {
                        $("#wrapper").css({"visibility" : "hidden"});
						menu.destroy();
						var game = new Game(cubes, hud);
                        game.setHP(10);
						graphics.setPosition(0, 0, -25);
						game.start();
                        stopAnimation();
					}
				});
				menu.addEntry({
					name : "Shop",
                    description : "Buy new cubes to boost up your ring with points earned from playing games.",
					method : function() {
						menu.destroy();
						var shop = new Shop(cubes);
                        graphics.displayRing();
						graphics.setPosition(5, 0, -12);
						shop.start();
                        stopAnimation();
					}
				});
                menu.start();
            }
            initGL(canvas, initGraphics);
        </script>
    </body>
</html>
